name: Update Rockchip armv8 Workflow Inputs

permissions:
  contents: write

on:
  push:
    paths:
      - 'immortalwrt_info.json'
  workflow_dispatch:

jobs:
  update_workflow:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure python3 is present
        run: sudo apt update && sudo apt install -y python3

      - name: Run profile and stability parser
        run: python3 .github/scripts/update_workflow_inputs.py

      - name: Patch Rockchip armv8.yml with new device_profiles and stability options
        run: |
          cp ".github/workflows/Rockchip armv8.yml" Rockchip_armv8.bak

          # 替换 device_profiles options
          awk '/device_profiles:/ {print;flag=1;next} flag && /options:/ {print;getline;while($0~/^ +-/){getline};flag=0;system("cat profile_options.txt");next} 1' Rockchip_armv8.bak > tmp1.yml

          # 替换 build_stability options
          awk '/build_stability:/ {print;flag=1;next} flag && /options:/ {print;getline;while($0~/^ +-/){getline};flag=0;system("cat stability_options.txt");next} 1' tmp1.yml > ".github/workflows/Rockchip armv8.yml"

      - name: Commit and push updated workflow file
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add ".github/workflows/Rockchip armv8.yml"
          git commit -m "chore: 自动更新 device_profiles 和 build_stability 选项 (来自 immortalwrt_info.json)" || echo "No changes"
          git push || echo "No changes to push"